*******		   《项目驱动创新学习训练营》			  *******
*******  A0201-海思HI3518E方案视频编解码传输深度学习  *******
*******	  第4季：图像sensor的特性和驱动解析		  	  *******

--------------------------------------------------------
本课程由朱老师物联网大讲堂推出并提供技术支持，更多技术问
题可以联系朱有鹏老师获取支持。版权所有，翻录必究
--------------------------------------------------------
第一部分、章节目录
4.1.本季课程主要内容和安排
4.2.更换OV9712并且做配置更改和测试
4.3.MIPI和LVDS和并口的细节讲解1
4.4.MIPI和LVDS和并口的细节讲解2
4.5.HI3518E的Sensor接口引脚复用设置1
4.6.HI3518E的Sensor接口引脚复用设置2
4.7.sensor驱动源码解析1
4.8.sensor驱动源码解析2
4.9.ISP_3A框架解读
4.10.sensor驱动编译实战
4.11.sensor驱动的寄存器操作
4.12.sensor驱动部分贯通总结


第二部分、章节介绍
4.1.本季课程主要内容和安排
	本节讲解课程的总体安排，和官方文档中关于sensor接口的描述部分。
4.2.更换OV9712并且做配置更改和测试
	本节在开发板上更换OV9712，并且做必要的配置更改，运行各个版本测试程序。
4.3.MIPI和LVDS和并口的细节讲解1
	本节讲解sensor的各种接口，本节主要讲了并口。
4.4.MIPI和LVDS和并口的细节讲解2
	本节接着讲解sensor的各种接口，本节主要讲了LVDS和MIPI CSI。
4.5.HI3518E的Sensor接口引脚复用设置1
	本节讲解sensor接口的引脚复用设置方法，主要是查引脚复用图。
4.6.HI3518E的Sensor接口引脚复用设置2
	本节继续讲解sensor接口引脚复用设置方法，主要是寄存器的设置。
4.7.sensor驱动源码解析1
	本节开始讲解sensor驱动的源码，主要是从框架结构出发讲解sensor驱动的架构。
4.8.sensor驱动源码解析2
	本节继续讲解sensor驱动源码，主要深入2个c文件中讲解sensor驱动的细节层次。
4.9.ISP_3A框架解读
	本节讲解ISP 3A手册，该手册是我们理解海思3A框架的关键，而sensor和isp就在这里。
4.10.sensor驱动编译实战
	本节首先回顾sensor驱动架构，然后以黑电平为案例，通过修改驱动重新编译实战来体验sensor驱动如何修改、提升实战能力。
4.11.sensor驱动的寄存器操作
	本节详解sensor驱动中和sensor寄存器设置有关的部分，并且以flip和mirror的设置为案例来演示如何查手册确定值并修改验证。
4.12.sensor驱动部分贯通总结
	本节对sensor驱动的整个部分做总结，结合整个课程学到的内容，提升大家对sensor本身的掌握和海思mpp体系中sensor、3A、isp相关部分理解。


第三部分、随堂记录
4.1.本季课程主要内容和安排
4.1.1、本课程主要内容
(1)查看SDK中相应文档，重点是SoC对Sensor的支持
(2)更换另一个Sensor（OV9712），并实现之前的实验
(3)Sensor接口：并口/LVDS/MIPI CSI
(4)SoC的Sensor接口引脚复用设置
(5)sensor驱动源码详解
(6)sample中sensor相关的部分详解
4.1.2、查看SDK的2个相关文档


4.2.更换OV9712并且做配置更改和测试
4.2.1、更改配置脚本
4.2.2、运行rtsp传输的测试版本
4.2.3、运行官方SDK sample的测试版本
4.2.4、运行ORTP传输的测试版本
4.2.5、更换sensor的总结
(1)程序框架做好多种sensor支持的框架
(2)注意硬件接线上面的差异
(3)加载不同的驱动，做不同的参数设置


4.3_4.MIPI和LVDS和并口的细节讲解1_2
4.3.1、并口Sensor
(1)OV9712和AR0130都是并口的
(2)并口的接口定义：参考AR0130的原理图pdf
(3)并口传输的是CMOS电平信号（重点是非差分）
(4)并口sensor属于较低端老旧的，新型高像素的都是MIPI/LVDS/HISPI等差分信号的
4.3.2、LVDS
(1)low voltage differential signal，低电压差分信号
(2)接口由1组差分clock和若干组差分信号线组成
(3)LVDS主要用于视频传输的2个领域：camera和主控、LCD和主控
(4)LVDS利用差分抗干扰能力，提升clock频率从而提升带宽，传输距离也更远
(5)LVDS的数据线组数越多带宽越大、clock频率越高带宽越大（牺牲抗干扰和距离）
(6)并口和LVDS之间可以互转，但是需要专门的电平转换芯片（类似于232和485）
4.3.3、MIPI（MIPI-CSI2）
(1)MIPI: mobile industry processor interface，移动工业处理器接口
(2)MIPI接口由1组差分clock和1-4组差分信号线组成
(3)MIPI和LVDS虽然都是差分对信号，但是不兼容，不能直接对接
(4)MIPI的架构层次更分明，广泛应用在手机平板等领域中，可以认为MIPI是LVDS的升级版
(5)MIPI的数据线组数越多带宽越大、clock频率越高带宽越大（牺牲抗干扰和距离）
(6)MIPI和LVDS和并口之间均可以互相转换，但是需要专门的电平转换芯片
4.3.4、总结
(1)老旧的、低端的、数据量小的就用电平信号；新的、高端的、数据量大的都用差分信号
(2)要通信，物理层、协议层、应用层都得能对接才行。
(3)因为历史原因，很多行业会使用不同的接口标准，必要时需要去互相转换


4.5_6.HI3518E的Sensor接口引脚复用设置1_2
4.5.1、查看引脚定义框图
4.5.2、找到相应设置寄存器
4.5.3、himm工具


4.7.sensor驱动源码解析1
4.7.1、sensor驱动源码寻找
(1)从sample入手
(2)sensor层驱动在component/isp中（mpp\component\isp\sensor\ar0130）
(3)底层i2c驱动在kernel中
4.7.2、sensor驱动的框架
(1)mpp定义了一套sensor驱动的实现和封装
(2)xxxx_cmos.c中定义回调和上层函数
(3)xxxx_sensor_ctl.c中定义底层硬件相关的寄存器值配置函数
(4)kernel中的I2C驱动提供i2c层面的物理层操作接口


4.8.sensor驱动源码解析2
4.8.1、xxxx_cmos.c中实现和注册回调
4.8.2、xxxx_sensor_ctl.c中配置sensor寄存器


4.9.ISP_3A框架解读


4.10.sensor驱动编译实战
4.10.1、sensor的注册接口分析
4.10.2、黑电平
4.10.3、sensor驱动编译实战
(1)修改驱动源码
(2)清除，并重新编译
(3)确认mpp中lib目录下的libsnsxxx.a/so已经被更新
(4)重新编译sample并运行查看效果


4.11.sensor驱动的寄存器操作
4.11.1、sensor的寄存器设置
(1)sensor内部有若干寄存器，可以通过I2C接口来读写
(2)数据手册有对寄存器的基本说明
(3)经验：大部分寄存器设置厂家会给，偶尔需要自己调一些
4.8.4、实战任务：修改sensor的flip和mirror寄存器查看效果
(1)查sensor数据手册的寄存器列表
(2)改sensor驱动代码
(3)重新编译isp
(4)确认sensor库已经更新到mpp中
(5)重新编译sample，运行测试


4.12.sensor驱动部分贯通总结
4.12.1、体系思想
(1)成熟的商业解决方案都是一整套设计好的模式
(2)第一步是理解，第二步是用起来，第三步是小修改，第四步是大修改，第五步是创造
4.12.2、海思方案的sensor驱动相关体系关键点
(1)搞清楚sensor的本质：光电转换+AD+ISP+并口/MIPI/LVDS
(2)ISP有多种实现：sensor内置、主SoC内置、外接专用ISP芯片
(3)3A是为最终图像效果负责的，3A的实现有赖于镜头、sensor、isp等各部门协同工作
(4)海思的体系中把sensor和3A、ISP实现为：指针挂接注册的各自独立模块
4.12.3、扩展学习方向
(1)sensor的各种参数
(2)其他几种sensor的驱动和对比实现
(3)isp的firmware
(4)3A算法相关知识

